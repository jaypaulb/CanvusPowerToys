function isColorDark(e){const t=parseInt(e.slice(1,3),16),n=parseInt(e.slice(3,5),16),s=parseInt(e.slice(5,7),16);return(t*.299+n*.587+s*.114)/255<.5}document.addEventListener("DOMContentLoaded",()=>{const d=document.querySelectorAll(".team-button"),f=document.getElementById("username"),r=document.getElementById("user-identification"),l=document.getElementById("message"),a=document.getElementById("user-dashboard"),c=document.getElementById("welcomeMessage"),t=document.getElementById("noteSquare"),u=document.getElementById("uploadItemButton"),h=document.getElementById("postNoteButton"),o=document.getElementById("qrcode");if(!f||!r||!a){console.error("RCU: Required elements not found");return}let s=null,n=null,i=null;const m={1:"rgb(255, 0, 0)",2:"rgb(255, 127, 0)",3:"rgb(255, 255, 0)",4:"rgb(0, 255, 0)",5:"rgb(0, 0, 255)",6:"rgb(75, 0, 130)",7:"rgb(139, 0, 255)"},p={1:"rgb(255, 255, 255)",2:"rgb(0, 0, 0)",3:"rgb(0, 0, 0)",4:"rgb(0, 0, 0)",5:"rgb(255, 255, 255)",6:"rgb(255, 255, 255)",7:"rgb(255, 255, 255)"};d.forEach(e=>{const t=parseInt(e.dataset.team);t&&m[t]&&(e.style.backgroundColor=m[t],e.style.color=p[t])});async function g(){if(!o)return;let e=null;try{const n=await fetch("/api/server-info");if(!n.ok)throw new Error(`HTTP ${n.status}`);const t=await n.json();if(t.ip&&t.ip!=="localhost"&&t.ip!=="127.0.0.1"){const n=window.location.protocol,s=t.port||window.location.port||"8080";e=`${n}//${t.ip}:${s}/rcu.html`}else if(t.url&&!t.url.includes("localhost")&&!t.url.includes("127.0.0.1"))e=`${t.url}/rcu.html`;else if(t.hostname&&t.hostname!=="localhost"&&t.hostname!=="127.0.0.1"){const n=window.location.protocol,s=t.port||window.location.port||"8080";e=`${n}//${t.hostname}:${s}/rcu.html`}}catch(e){console.error("Failed to fetch server info for QR code:",e)}if(!e||e.includes("localhost")||e.includes("127.0.0.1")){o.innerHTML='<p style="color: red;">Error: Could not determine server IP address. QR code unavailable.</p>';return}if(o.innerHTML="",typeof QRCode=="undefined"){o.innerHTML="<p>QR Code library not loaded</p>";return}const t=new QRCode(o,{text:e,width:256,height:256,colorDark:"#000",colorLight:"#fff",correctLevel:QRCode.CorrectLevel.H});o.parentElement&&(o.parentElement.style.textAlign="center",o.style.display="inline-block")}g();function e(e,t){l&&(l.textContent=e,l.className=`message ${t}`,l.style.display="block")}d.forEach(o=>{o.addEventListener("click",async()=>{const l=f.value.trim();if(!l){e("Please enter your name first.","error");return}d.forEach(e=>e.classList.remove("active")),o.classList.add("active"),s=parseInt(o.dataset.team),n=l;try{const l=await fetch("/identify-user",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({team:s,name:n})}),o=await l.json();if(l.ok&&o.success){i=o.color;try{const e=await fetch("/api/canvas/info"),o=await e.json(),l=o.canvas_name||"Unknown Canvas";r&&(r.style.display="none"),a&&(a.style.display="block",c&&(c.textContent=`Welcome, ${n}, you are currently posting to Team ${s} on ${l}.`),t&&(t.style.backgroundColor=i,t.style.color=isColorDark(i)?"#FFFFFF":"#000000"))}catch(e){console.error("Error fetching canvas info:",e),r&&(r.style.display="none"),a&&(a.style.display="block",c&&(c.textContent=`Welcome, ${n}, you are currently posting to Team ${s}.`),t&&(t.style.backgroundColor=i,t.style.color=isColorDark(i)?"#FFFFFF":"#000000"))}e("Identification successful!","success")}else e(o.error||"Identification failed.","error")}catch(t){console.error("Error identifying user:",t),e("An error occurred during identification.","error")}})}),h&&h.addEventListener("click",async()=>{if(!t)return;const o=t.textContent.trim();if(!o){e("Please enter text in the note.","error");return}if(!s||!n||!i){e("Please identify yourself first.","error");return}try{const a=await fetch("/create-note",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({team:s,name:n,text:o,color:i})}),r=await a.json();a.ok&&r.success?(e("Note posted successfully!","success"),t.textContent=""):e(r.error||"Failed to post note.","error")}catch(t){console.error("Error posting note:",t),e("An error occurred while posting the note.","error")}}),u&&u.addEventListener("click",()=>{if(!s||!n){e("Please identify yourself first.","error");return}const t=document.createElement("input");t.type="file",t.accept=".jpg,.jpeg,.png,.gif,.bmp,.tiff,.mp4,.avi,.mov,.wmv,.pdf,.mkv",t.onchange=async()=>{const o=t.files[0];if(o){const t=new FormData;t.append("team",s),t.append("name",n),t.append("file",o);try{e("Uploading file...","loading");const s=await fetch("/upload-item",{method:"POST",body:t}),n=await s.json();s.ok&&n.success?e(n.message||"File uploaded successfully!","success"):e(n.error||"Upload failed.","error")}catch(t){console.error("Error uploading file:",t),e("An error occurred while uploading the file.","error")}}},t.click()})})