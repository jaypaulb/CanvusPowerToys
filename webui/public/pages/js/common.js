let errorHandler;typeof ErrorHandler!="undefined"?errorHandler=new ErrorHandler:errorHandler={logError:(e,t,n)=>{(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")&&console.error(n?`${n}: ${e}`:e,t)}},document.addEventListener("DOMContentLoaded",()=>{initMobileMenu(),initCanvasHeader(),initWorkspaceClient()});function initMobileMenu(){const t=document.getElementById("mobileMenuToggle"),e=document.getElementById("mobileMenu");t&&e&&(t.addEventListener("click",()=>{e.classList.toggle("open")}),document.addEventListener("click",n=>{!e.contains(n.target)&&!t.contains(n.target)&&e.classList.remove("open")}))}function initCanvasHeader(){const t=window.location.origin,n=sessionStorage.getItem("clientName"),o=sessionStorage.getItem("clientWarning")==="true",e=document.getElementById("navbarClientName"),s=document.getElementById("navbarClientWarning");e&&n&&(e.textContent=n),s&&(s.style.display=o?"inline":"none"),e&&e.addEventListener("dblclick",async()=>{try{const c=await fetch(`${t}/api/clients`);if(!c.ok)throw new Error(`HTTP ${c.status}`);const s=await c.json();if(!s.success||!s.clients||s.clients.length===0){alert("No clients available");return}const f=e.textContent.replace("✓ ",""),n=document.createElement("select");n.className="client-select-dropdown",n.style.cssText=`
          position: fixed;
          z-index: 10000;
          padding: 8px 12px;
          border: 1px solid var(--border-color, #ccc);
          border-radius: var(--radius-md, 4px);
          background-color: var(--bg-card, #fff);
          color: var(--text-primary, #000);
          font-size: var(--font-size-sm, 14px);
          font-family: inherit;
          cursor: pointer;
          box-shadow: 0 4px 12px rgba(0,0,0,0.2);
          min-width: 220px;
          max-height: 300px;
          outline: none;
        `;const r=document.createElement("option");r.value="",r.textContent="-- Select Client --",n.appendChild(r),s.clients.forEach(e=>{const t=document.createElement("option");t.value=e.name,t.textContent=e.name,e.name===f&&(t.selected=!0),n.appendChild(t)});const o=e.getBoundingClientRect(),l=window.scrollY||window.pageYOffset,m=window.scrollX||window.pageXOffset;let d=o.bottom+l+4;const u=window.innerHeight;o.bottom+300>u&&(d=o.top+l-300-4),n.style.top=`${Math.max(4,d)}px`,n.style.left=`${o.left+m}px`,document.body.appendChild(n),n.focus();const h=async()=>{const s=n.value;if(!s){document.body.removeChild(n);return}document.body.removeChild(n);try{const n=await fetch(`${t}/api/client/override`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_name:s})});if(!n.ok){const e=await n.text();throw new Error(`HTTP ${n.status}: ${e}`)}const o=await n.json();o.success?(e.textContent=o.client_name||s,sessionStorage.setItem("clientName",o.client_name||s),e.textContent="✓ "+e.textContent,setTimeout(()=>{window.location.reload()},500)):alert("Failed to override client: "+(o.error||"Unknown error"))}catch(e){errorHandler.logError("Error overriding client",e,"ClientOverride");let t="Error overriding client";e.message&&(t=e.message),alert(t)}};n.addEventListener("change",h);const i=e=>{e.key==="Escape"&&(document.body.contains(n)&&document.body.removeChild(n),document.removeEventListener("keydown",i),document.removeEventListener("click",a))},a=t=>{!n.contains(t.target)&&t.target!==e&&(document.body.contains(n)&&document.body.removeChild(n),document.removeEventListener("keydown",i),document.removeEventListener("click",a))};document.addEventListener("keydown",i),setTimeout(()=>{document.addEventListener("click",a)},100)}catch(e){errorHandler.logError("Error fetching clients",e,"ClientList"),alert("Error fetching client list: "+(e.message||"Unknown error"))}}),fetch(`${t}/api/installation/info`).then(e=>e.json()).then(e=>{console.log("[common.js] Installation info received:",e);const s=document.getElementById("navbarClientName"),i=document.getElementById("navbarCanvasName"),t=document.getElementById("navbarClientWarning"),o=document.getElementById("clientNameDisplay"),n=document.getElementById("clientWarning");if(i&&(e.canvas_name?(i.textContent=e.canvas_name,sessionStorage.setItem("canvasName",e.canvas_name)):e.canvas_id?i.textContent=e.canvas_id.substring(0,8)+"...":i.textContent="..."),e.connected&&e.client_id){const i=e.client_name||e.client_id||e.installation_name||"Connected";s&&(s.textContent=i,sessionStorage.setItem("clientName",i)),t&&(e.client_id&&!e.client_name?(t.style.display="inline",t.textContent="(No name)"):t.style.display="none"),o&&(o.textContent=i),n&&(e.client_id&&!e.client_name?(n.style.display="inline",n.textContent="(Client has no name)"):n.style.display="none"),sessionStorage.setItem("clientWarning",e.client_id&&!e.client_name?"true":"false")}else e.client_name?(s&&(s.textContent=e.client_name,sessionStorage.setItem("clientName",e.client_name)),t&&(t.style.display="none"),o&&(o.textContent=e.client_name),n&&(n.style.display="none"),sessionStorage.setItem("clientWarning","false")):e.installation_name?(s&&(s.textContent=e.installation_name,sessionStorage.setItem("clientName",e.installation_name)),t&&(t.style.display="inline",t.textContent=e.client_id?"(No name)":"(Not found)"),o&&(o.textContent=e.installation_name),n&&(n.style.display="inline",n.textContent=e.client_id?"(Client has no name)":"(Client not found on server)"),sessionStorage.setItem("clientWarning","true")):(s&&(s.textContent="Unknown",sessionStorage.setItem("clientName","Unknown")),t&&(t.style.display="none"),o&&(o.textContent="Unknown"),n&&(n.style.display="none"),sessionStorage.setItem("clientWarning","false"))}).catch(e=>{errorHandler.logError("Failed to fetch installation info",e,"NavbarTracking")})}function initWorkspaceClient(){if(typeof WorkspaceClient=="undefined")return;const e=new WorkspaceClient,o=window.location.origin;e.on("connected",()=>{t("connected","Connected")}),e.on("disconnected",()=>{t("disconnected","Disconnected")}),e.on("reconnecting",e=>{t("connecting",`Reconnecting (${e})...`)}),e.on("canvas_update",e=>{if(console.log("[common.js] canvas_update event received:",e),e.client_name){const t=document.getElementById("navbarClientName");t&&(t.textContent=e.client_name,sessionStorage.setItem("clientName",e.client_name))}if(e.canvas_name){const t=document.getElementById("navbarCanvasName");t&&(t.textContent=e.canvas_name,sessionStorage.setItem("canvasName",e.canvas_name))}});function t(e,t){const n=document.getElementById("navbarStatusIndicator"),s=document.getElementById("navbarStatusText"),o=document.getElementById("statusIndicator"),i=document.getElementById("statusText");n&&(n.className=`navbar-status-indicator ${e}`),s&&(s.textContent=t),o&&(o.className=`status-indicator ${e}`),i&&(i.textContent=t),sessionStorage.setItem("connectionStatus",e),sessionStorage.setItem("connectionStatusText",t)}const n=sessionStorage.getItem("connectionStatus"),s=sessionStorage.getItem("connectionStatusText");n&&s&&t(n,s),e.connect(o)}