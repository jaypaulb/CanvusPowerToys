document.addEventListener("DOMContentLoaded",()=>{console.log("[macros.js] DOMContentLoaded - Initializing macros page"),console.log("[macros.js] Setting up tabs"),setupTabs(),console.log("[macros.js] Fetching zones"),fetchZones();const e=document.getElementById("moveButton"),t=document.getElementById("copyButton");console.log("[macros.js] Binding Manage buttons:",{moveButton:!!e,copyButton:!!t}),e?e.addEventListener("click",()=>{console.log("[macros.js] Move button clicked"),manageMove()}):console.error("[macros.js] ERROR: moveButton not found!"),t?t.addEventListener("click",()=>{console.log("[macros.js] Copy button clicked"),manageCopy()}):console.error("[macros.js] ERROR: copyButton not found!");const n=document.getElementById("autoGridButton"),s=document.getElementById("groupColorButton"),o=document.getElementById("groupTitleButton");console.log("[macros.js] Binding Grouping buttons:",{autoGridButton:!!n,groupColorButton:!!s,groupTitleButton:!!o}),n?n.addEventListener("click",()=>{console.log("[macros.js] Auto Grid button clicked"),autoGrid()}):console.error("[macros.js] ERROR: autoGridButton not found!"),s?s.addEventListener("click",()=>{console.log("[macros.js] Group by Color button clicked"),groupByColor()}):console.error("[macros.js] ERROR: groupColorButton not found!"),o?o.addEventListener("click",()=>{console.log("[macros.js] Group by Title button clicked"),groupByTitle()}):console.error("[macros.js] ERROR: groupTitleButton not found!");const i=document.getElementById("pinAllButton"),a=document.getElementById("unpinAllButton");console.log("[macros.js] Binding Pinning buttons:",{pinAllButton:!!i,unpinAllButton:!!a}),i?i.addEventListener("click",()=>{console.log("[macros.js] Pin All button clicked"),pinAll()}):console.error("[macros.js] ERROR: pinAllButton not found!"),a?a.addEventListener("click",()=>{console.log("[macros.js] Unpin All button clicked"),unpinAll()}):console.error("[macros.js] ERROR: unpinAllButton not found!"),console.log("[macros.js] Setting up color tolerance slider"),setupColorToleranceSlider(),console.log("[macros.js] Initialization complete")});function setupTabs(){const e=document.querySelectorAll(".tab-button"),t=document.querySelectorAll(".tab-content");e.forEach(n=>{n.addEventListener("click",()=>{e.forEach(e=>e.classList.remove("active")),t.forEach(e=>e.classList.remove("active")),n.classList.add("active");const o=n.getAttribute("data-tab"),s=document.getElementById(`${o}-content`);s&&s.classList.add("active")})})}async function fetchZones(){try{console.log("[fetchZones] Fetching zones and canvas details...");const t=await fetch("/get-zones",{headers:{"Cache-Control":"no-cache"}}),e=await t.json();if(!e.success||!e.zones)throw new Error("Failed to retrieve zones from the server.");console.log(`[fetchZones] Retrieved ${e.zones.length} zones.`),populateZoneDropdowns(e.zones)}catch(e){console.error("[fetchZones] Error:",e.message),displayMessage(e.message,"error")}}function populateZoneDropdowns(e){try{const t={manageSourceZone:document.getElementById("manageSourceZone"),manageTargetZone:document.getElementById("manageTargetZone"),arrangeSourceZone:document.getElementById("arrangeSourceZone"),pinSourceZone:document.getElementById("pinSourceZone")};Object.values(t).forEach(e=>{e&&(e.innerHTML='<option value="">Select a zone...</option>')});const n=[...e].sort((e,t)=>{const n=(e.anchor_name||"").toLowerCase(),s=(t.anchor_name||"").toLowerCase();return n.localeCompare(s,0[0],{numeric:!0})});n.forEach(e=>{const s=e.anchor_name||`Zone ${e.id}`,n=document.createElement("option");n.value=e.id,n.textContent=s,Object.values(t).forEach(e=>{e&&e.appendChild(n.cloneNode(!0))})})}catch(e){console.error("[populateZoneDropdowns] Error:",e.message),displayMessage("Error populating zone dropdowns: "+e.message,"error")}}async function manageMove(){console.log("[macros.js] manageMove() called");const e=document.getElementById("manageSourceZone")?.value,t=document.getElementById("manageTargetZone")?.value;if(console.log("[macros.js] Zone IDs:",{sourceZoneId:e,targetZoneId:t}),!e||!t){const e="Please select both Source and Target zones.";console.warn("[macros.js] Validation failed:",e),displayMessage(e,"error");return}try{const n={sourceZoneId:e,targetZoneId:t};console.log("[macros.js] Sending POST /api/macros/move with payload:",n);const s=await postJson("/api/macros/move",n);console.log("[macros.js] Move response:",s),displayMessage(s.message||"Widgets moved successfully","success")}catch(e){console.error("[macros.js] Move failed:",e),displayMessage(e.message||"Failed to move widgets","error")}}async function manageCopy(){console.log("[macros.js] manageCopy() called");const e=document.getElementById("manageSourceZone")?.value,t=document.getElementById("manageTargetZone")?.value;if(console.log("[macros.js] Zone IDs:",{sourceZoneId:e,targetZoneId:t}),!e||!t){const e="Please select both Source and Target zones.";console.warn("[macros.js] Validation failed:",e),displayMessage(e,"error");return}try{const n={sourceZoneId:e,targetZoneId:t};console.log("[macros.js] Sending POST /api/macros/copy with payload:",n);const s=await postJson("/api/macros/copy",n);console.log("[macros.js] Copy response:",s),displayMessage(s.message||"Widgets copied successfully","success")}catch(e){console.error("[macros.js] Copy failed:",e),displayMessage(e.message||"Failed to copy widgets","error")}}async function autoGrid(){console.log("[macros.js] autoGrid() called");const e=document.getElementById("arrangeSourceZone")?.value;if(console.log("[macros.js] Zone ID:",e),!e){const e="Please select a Source zone.";console.warn("[macros.js] Validation failed:",e),displayMessage(e,"error");return}try{const t={zoneId:e};console.log("[macros.js] Sending POST /api/macros/auto-grid with payload:",t);const n=await postJson("/api/macros/auto-grid",t);console.log("[macros.js] Auto grid response:",n),displayMessage(n.message||"Auto grid applied successfully","success")}catch(e){console.error("[macros.js] Auto grid failed:",e),displayMessage(e.message||"Failed to apply auto grid","error")}}async function groupByColor(){console.log("[macros.js] groupByColor() called");const e=document.getElementById("arrangeSourceZone")?.value,t=document.getElementById("colorToleranceSlider")?.value;if(console.log("[macros.js] Zone ID:",e,"Color tolerance:",t),!e){const e="Please select a Source zone.";console.warn("[macros.js] Validation failed:",e),displayMessage(e,"error");return}try{const n={zoneId:e,colorTolerance:parseInt(t)};console.log("[macros.js] Sending POST /api/macros/group-color with payload:",n);const s=await postJson("/api/macros/group-color",n);console.log("[macros.js] Group by color response:",s),displayMessage(s.message||"Grouped by color successfully","success")}catch(e){console.error("[macros.js] Group by color failed:",e),displayMessage(e.message||"Failed to group by color","error")}}async function groupByTitle(){console.log("[macros.js] groupByTitle() called");const e=document.getElementById("arrangeSourceZone")?.value;if(console.log("[macros.js] Zone ID:",e),!e){const e="Please select a Source zone.";console.warn("[macros.js] Validation failed:",e),displayMessage(e,"error");return}try{const t={zoneId:e};console.log("[macros.js] Sending POST /api/macros/group-title with payload:",t);const n=await postJson("/api/macros/group-title",t);console.log("[macros.js] Group by title response:",n),displayMessage(n.message||"Grouped by title successfully","success")}catch(e){console.error("[macros.js] Group by title failed:",e),displayMessage(e.message||"Failed to group by title","error")}}async function pinAll(){console.log("[macros.js] pinAll() called");const e=document.getElementById("pinSourceZone")?.value;if(console.log("[macros.js] Zone ID:",e),!e){const e="Please select a Source zone.";console.warn("[macros.js] Validation failed:",e),displayMessage(e,"error");return}try{const t={zoneId:e};console.log("[macros.js] Sending POST /api/macros/pin-all with payload:",t);const n=await postJson("/api/macros/pin-all",t);console.log("[macros.js] Pin all response:",n),displayMessage(n.message||"All widgets pinned successfully","success")}catch(e){console.error("[macros.js] Pin all failed:",e),displayMessage(e.message||"Failed to pin widgets","error")}}async function unpinAll(){console.log("[macros.js] unpinAll() called");const e=document.getElementById("pinSourceZone")?.value;if(console.log("[macros.js] Zone ID:",e),!e){const e="Please select a Source zone.";console.warn("[macros.js] Validation failed:",e),displayMessage(e,"error");return}try{const t={zoneId:e};console.log("[macros.js] Sending POST /api/macros/unpin-all with payload:",t);const n=await postJson("/api/macros/unpin-all",t);console.log("[macros.js] Unpin all response:",n),displayMessage(n.message||"All widgets unpinned successfully","success")}catch(e){console.error("[macros.js] Unpin all failed:",e),displayMessage(e.message||"Failed to unpin widgets","error")}}function setupColorToleranceSlider(){const e=document.getElementById("colorToleranceSlider"),t=document.getElementById("colorToleranceValue");e&&t&&e.addEventListener("input",e=>{t.textContent=e.target.value+"%"})}async function postJson(e,t){console.log("[macros.js] postJson() - URL:",e,"Payload:",t);const n=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(console.log("[macros.js] postJson() - Response status:",n.status,n.statusText),!n.ok){const e=await n.text();console.error("[macros.js] postJson() - Error response:",e);let t;try{t=JSON.parse(e)}catch{t={error:e||"Request failed"}}throw new Error(t.error||`HTTP ${n.status}`)}const s=await n.json();return console.log("[macros.js] postJson() - Success response:",s),s}function displayMessage(e,t){const n=document.getElementById("manageMessage")||document.getElementById("arrangeMessage")||document.getElementById("pinMessage");n?(n.textContent=e,n.className=`message ${t} mt-md`,n.style.display="block",setTimeout(()=>{n.style.display="none"},5e3)):console.log(`[${t}] ${e}`)}